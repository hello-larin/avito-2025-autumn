# avito-2025-autumn
Стажировка Авито Бекенд Осень 2025

.env в гитхабе положенно специально. Оно необходимо для запуска. Очевидно что при обычной разработке оно не должно быть доступно публично.

## Запуск
### запуск сервиса и БД - выполнять в корневой папке проекта где лежит .env

```
docker-compose up --build
```

### миграции - выполнять в корневой папке проекта где лежит .env
```
goose up
```

## Дополнительные задания

- [x] Описать конфигурацию линтера.
- [ ] Добавить метод массовой деактивации пользователей команды и безопасную переназначаемость открытых PR (стремиться уложиться в 100 мс для средних объёмов данных).
  -  Сделал транзакции через библиотеку AVITO. При создании команды, pr, смены на другого пользователя
  -  Не особо понимаю на кого надо переназначать PR. Типа автор сменил команду и надо при деактивации старой команды раздать права ревьювера новой команде автора?
  -  Если это так то не особо отличается от создания нового пулл реквеста, только перед всем этим проверить команду автора что она отличается от ревьювера.
- [ ] Реализовать интеграционное или E2E-тестирование.
  - Сделал тесты всех ручек в постмане

## Ход работы

Проблемы и решения
- Если пользователь не назначен ревьювером ни в каком pr то показывать NOT_FOUND или пустой список
  - Решение: буду показывать пустой список
- Можно ли создавать PR если у команды нет пользователей которых можно поставить в reviewers
  - Решение: создавать с пустым списком reviewers
- В reassign в коде ошибки 409 есть "пользователь не назначен ревьювером" и есть 404 пользователь не найден. И какой отдавать?
  - Решение: отдавать 409
- Есть тег health но нет ручки
  - Решение: добавил сам ручку /health

Особенности работы:
- Использовал стандартное расположение папок
- Интерфейсы приватные и объявлены там где используются. Т.е. интерфейс репозитория объявлен в юзкейсе и при этом только нужные функции.
- DTO только на уровне delivery и тоже скрыты. На уровни вниз передаём только модельки
- Отдельные функции для конвертации из DTO в модели и обратно и тоже приватные и тоже на уровне delivery для каждого сервиса
- Ошибки обрабатываются в одном месте internal/error/error.go . Там же хранятся все ошибки
- *Использую либу AVITO для транзакций*
  - Изначально хотел сделать свою, но pgx.pool и pgx.Tx это не одно и тоже поэтому на скорую руку не вышло. Посмотрел что в авито есть для этого решение и использовал его
- В запросах использую новые функции pgx для scan ответа бд в структуру - через генерики и теги db у структуры. Из-за этого не надо писать каждый раз логику закрытия - само закроется, но есть проблема - новые функции работают только с rows а не row поэтому везде приходится использовать Query.
- go-validator - валидация пляшет от тегов структуры. Использовал здесь для requirement, НО можно добавить либо правила поставляемые с библиотекой либо написать свои - например определённый формат id для PR (pr-xxxx)
- использую middleware от chi и сам chi роутер - является небольшим сахарком над стандартным роутером.
- Использую goose для миграций. Разбил миграции по частям - по таблицам нужным для сервисов.

Кривота api:
- очень кривые json ответы - везде разные в том смысле что добавляется ещё 1 уровень вложенности, а иногда не добавляется.
- в модели pullrequest снизу свагера есть created_at при этом в примерах ответа оно не используется -_-

Моя кривота:
- нейминг - хотел как лучше а получилось как всегда. В структурах в полях дублируется название структуры (pullRequestId). Не нравится как-то нейминг функций - тоже думаю можно было лучше назвать. Разные названия функция на разных уровнях (для одинаковых действий)
- глобальный slog - надо во все сервисы явно прокинуть. Ещё прикольно было бы сделать для каждого сервиса и уровня обёртку что за сервис и что за уровень. Это как-то точно можно сделать - читал статью на хабре
- нет комментариев для пакетов и функций - на это ругался revive пришлось добавить эти правила в исключения
- логи есть не везде